<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Blynclight Rules Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-sec: #64748b;
            --open: #10b981;
            --focused: #ef4444;
            --away: #3b82f6;
            --off: #94a3b8;
            --error: #ef4444;
            --radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: block;
        }

        .container {
            width: 100%;
            max-width: 680px;
            padding: 18px 14px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            font-weight: 600;
            font-size: 11px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .card-promoted {
            background: #ffffff;
            border: 1px solid var(--border);
            border-top: 2px solid var(--primary);
            box-shadow: 0 12px 30px -10px rgba(99, 102, 241, 0.08);
        }

        .card-demoted {
            padding: 20px 28px;
            background: #fcfdfe;
            border-style: dashed;
            opacity: 0.85;
        }

        .card-demoted h2 {
            font-size: 11px;
            margin-bottom: 12px;
        }

        h2 {
            font-size: 11px;
            font-weight: 700;
            margin: 0 0 16px 0;
            color: var(--text-sec);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .default-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        select,
        input:not([type="checkbox"]) {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
        }

        input[type="checkbox"] {
            opacity: 0.6;
            transform: scale(0.9);
            cursor: pointer;
            accent-color: var(--primary);
            margin: 0;
        }

        input[type="checkbox"]:checked {
            opacity: 1;
        }

        .rules-list {
            margin-top: 10px;
        }

        .rule-row {
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            position: relative;
            transition: background 0.1s, border-color 0.1s;
        }

        .rule-row:hover {
            background: #fcfdfe;
            border-color: var(--border);
        }

        .rule-row.has-error {
            border-color: #fecaca;
            background: #fffafa;
            border-bottom: none;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            margin-bottom: 0;
        }

        .validation-msg {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--error);
            font-size: 10px;
            font-weight: 600;
            padding: 6px 16px;
            background: #fff5f5;
            border: 1px solid #fecaca;
            border-top: none;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            margin-top: 0;
            margin-bottom: 12px;
            position: relative;
        }

        .rule-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .days-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            /* Tighter gap for compressed days */
        }

        .day-pill {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #f1f5f9;
            background: #f8fafc;
            color: var(--text-sec);
            user-select: none;
            text-transform: uppercase;
        }

        .day-pill.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .rule-bottom {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 13px;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-label {
            color: var(--text-sec);
            font-size: 13px;
            width: 42px;
            display: inline-block;
            font-weight: 500;
        }

        .time-parts {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .time-parts input {
            padding: 4px 8px;
            width: 55px !important;
            text-align: center;
            font-size: 11px;
            height: 24px;
            box-sizing: border-box;
            background: #ffffff;
        }

        .time-parts select {
            padding: 2px 4px;
            font-size: 11px;
            height: 24px;
            box-sizing: border-box;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
        }

        .to-label {
            color: var(--text-sec);
            font-size: 12px;
            font-weight: 700;
            width: 45px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-add {
            background: var(--bg);
            border: 1px dashed var(--text-sec);
            width: 100%;
            margin-top: 4px;
            color: var(--text-sec);
        }

        .btn-del {
            color: #94a3b8;
            background: none;
            border: none;
            outline: none;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border-radius: 6px;
        }

        .btn-del:hover {
            color: var(--error);
            transform: scale(1.1);
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: .2s;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        input:checked+.slider {
            background-color: var(--focused);
            border-color: var(--focused);
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }

        .btn-save {
            width: 100%;
            margin-top: 16px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .segmented-control {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
            gap: 2px;
        }

        .seg-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-sec);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
        }

        .seg-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            color: var(--text);
        }

        .seg-btn.active[data-state="open"] {
            background: white;
            color: var(--open);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .seg-btn.active[data-state="focused"] {
            background: white;
            color: var(--focused);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .seg-btn.active[data-state="away"] {
            background: white;
            color: var(--away);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .seg-btn.active[data-state="off"] {
            background: white;
            color: var(--text);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .seg-btn i {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
            transition: background 0.2s;
        }

        .seg-btn.active[data-state="open"] i {
            background: var(--open);
        }

        .seg-btn.active[data-state="focused"] i {
            background: var(--focused);
        }

        .seg-btn.active[data-state="away"] i {
            background: var(--away);
        }

        .seg-btn.active[data-state="off"] i {
            background: var(--text);
            border-radius: 0;
            clip-path: polygon(40% 0%, 60% 0%, 60% 40%, 100% 40%, 100% 60%, 60% 60%, 60% 100%, 40% 100%, 40% 60%, 0% 60%, 0% 40%, 40% 40%);
        }

        /* simple plus/power cross if needed or just circle */

        /* Better power icon for off */
        .seg-btn[data-state="off"] i {
            background: transparent;
            border: 1.5px solid #cbd5e1;
            width: 7px;
            height: 7px;
        }

        .seg-btn.active[data-state="off"] i {
            border-color: var(--text);
        }

        #toast {
            position: fixed;
            top: 20px;
            background: var(--open);
            color: white;
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: 600;
            transform: translateY(-100px);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 1000;
        }

        #toast.show {
            transform: translateY(0);
        }

        /* Custom Status Select */
        .custom-select {
            position: relative;
            width: 120px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
        }

        .select-trigger {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .select-trigger:after {
            content: "";
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid var(--text-sec);
            margin-left: 8px;
            transition: transform 0.2s;
        }

        .custom-select.open .select-trigger:after {
            transform: rotate(180deg);
        }

        .select-options {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            z-index: 200;
            display: none;
            overflow: hidden;
            animation: slideUp 0.15s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .custom-select.open .select-options {
            display: block;
        }

        .option-item {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
            color: var(--text-sec);
        }

        .option-item:hover {
            background: #f8fafc;
        }

        .option-item.active {
            background: #f1f5f9;
        }
    </style>
</head>

<body>
    <div id="toast">Settings Saved & Applied</div>
    <div class="container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:8px; height:8px; background:var(--primary); border-radius:50%; opacity: 0.6;"></div>
                <h1 style="margin:0; font-size: 14px; font-weight:600; color: var(--text-sec);">Blynclight Dashboard
                </h1>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div id="device-status" class="status-badge"
                    style="opacity: 0.8; border-color: transparent; background: #eaeff2; gap: 6px;">
                    <div id="device-dot" class="dot" style="width: 5px; height: 5px; background: #94a3b8;"></div>
                    <span id="device-txt"
                        style="font-weight: 500; color: #64748b; font-size: 10px;">Connecting...</span>
                </div>

                <div class="status-badge">
                    <div id="status-dot" class="dot" style="width: 6px; height: 6px;"></div>
                    <span id="status-txt">Evaluating...</span>
                </div>
            </div>
        </header>

        <!-- PRIMARY: Manual Override -->
        <div class="card">
            <h2>Manual Override</h2>
            <div style="display:flex; align-items: center; gap:12px; flex-wrap: wrap;">
                <div class="segmented-control">
                    <button id="btn-open" class="seg-btn btn-force" data-state="open" onclick="forceState('open')">
                        <i></i> Open
                    </button>
                    <button id="btn-focused" class="seg-btn btn-force" data-state="focused"
                        onclick="forceState('focused')">
                        <i></i> Focused
                    </button>
                    <button id="btn-away" class="seg-btn btn-force" data-state="away" onclick="forceState('away')">
                        <i></i> Away
                    </button>
                    <button id="btn-off" class="seg-btn btn-force" data-state="off" onclick="forceState('off')">
                        <i></i> Off
                    </button>
                </div>
                <button id="resume-btn" class="btn"
                    style="background: transparent; color:var(--text-sec); border:1px solid var(--border); font-size:11px; padding:6px 14px; display:none; border-radius: 10px;"
                    onclick="forceState(null)">Resume Schedule</button>
            </div>
        </div>

        <!-- SECONDARY: Scheduled Rules -->
        <div class="card card-promoted">
            <h2>Scheduled Rules</h2>
            <div id="rules-container" class="rules-list"></div>
            <button class="btn btn-add" onclick="addRule()">+ Add New Rule</button>

            <!-- Inline Fallback & Startup -->
            <div
                style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #f1f5f9; display: flex; flex-direction: column; gap: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <h3
                            style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin:0; font-weight: 700;">
                            Fallback</h3>
                        <span style="font-size: 12px; color: #94a3b8; font-weight: 500;">(When no rules match)</span>
                    </div>
                    <div id="fallback-select-container"></div>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <h3
                            style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin:0; font-weight: 700;">
                            General</h3>
                        <span style="font-size: 12px; color: #94a3b8; font-weight: 500;">Launch at Startup</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="startup-toggle"
                            onchange="config.start_on_login = this.checked; render();">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <button class="btn btn-primary btn-save" onclick="saveConfig()" style="margin-top: 24px;">Save & Apply
                changes</button>
        </div>

    </div>

    <script>
        let config = { rules: [] };
        let initialConfig = null;
        const DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        async function load() {
            const r = await fetch('/config');
            config = await r.json();
            initialConfig = JSON.stringify(config); // Deep copy for dirty check
            render();
            updateStatusDisplay();
        }

        function isDirty() {
            if (!initialConfig) return false;
            return JSON.stringify(config) !== initialConfig;
        }

        window.onbeforeunload = (e) => {
            if (isDirty()) {
                e.preventDefault();
                e.returnValue = "You have unsaved changes. Discard or stay?";
                return e.returnValue;
            }
        };

        function timeToMin(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        function validateRules() {
            const errors = config.rules.map(() => ({ overlapDays: [] }));
            const enabledRules = config.rules.map((r, i) => ({ ...r, index: i })).filter(r => r.enabled);

            for (let i = 0; i < enabledRules.length; i++) {
                for (let j = i + 1; j < enabledRules.length; j++) {
                    const r1 = enabledRules[i];
                    const r2 = enabledRules[j];

                    // Check common days
                    const commonDays = r1.days.filter(d => r2.days.includes(d));
                    if (commonDays.length === 0) continue;

                    // Check time overlap
                    const s1 = timeToMin(r1.start);
                    const e1 = timeToMin(r1.end);
                    const s2 = timeToMin(r2.start);
                    const e2 = timeToMin(r2.end);

                    if (s1 < e2 && e1 > s2) {
                        // Collision!
                        commonDays.forEach(d => {
                            if (!errors[r1.index].overlapDays.includes(d)) errors[r1.index].overlapDays.push(d);
                            if (!errors[r2.index].overlapDays.includes(d)) errors[r2.index].overlapDays.push(d);
                        });
                    }
                }
            }
            return errors;
        }

        // Helper: Convert 24h (HH:MM) to 12h components
        function to12h(timeStr) {
            let [h, m] = timeStr.split(':').map(Number);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return { h: h.toString().padStart(2, '0'), m: m.toString().padStart(2, '0'), ampm };
        }

        // Helper: Convert 12h components to 24h (HH:MM)
        function to24h(h, m, ampm) {
            h = parseInt(h);
            if (ampm === 'PM' && h < 12) h += 12;
            if (ampm === 'AM' && h === 12) h = 0;
            return h.toString().padStart(2, '0') + ":" + m.toString().padStart(2, '0');
        }

        const STATE_MAP = {
            open: { label: 'Open', color: 'var(--open)', dot: '●' },
            focused: { label: 'Focused', color: 'var(--focused)', dot: '●' },
            away: { label: 'Away', color: 'var(--away)', dot: '●' },
            off: { label: 'Off', color: 'var(--text-sec)', dot: '○' }
        };

        function createCustomSelect(currentValue, onChange) {
            const container = document.createElement('div');
            container.className = 'custom-select';
            const state = STATE_MAP[currentValue] || STATE_MAP.off;

            container.innerHTML = `
                <div class="select-trigger" style="color: ${state.color}; border-color: ${state.color.replace(')', ', 0.3)')}; background: ${state.color.replace('var(--', 'rgba(').replace(')', ', 0.05)')}">
                    <span>${state.dot} ${state.label}</span>
                </div>
                <div class="select-options">
                    ${Object.entries(STATE_MAP).map(([val, info]) => `
                        <div class="option-item ${val === currentValue ? 'active' : ''}" 
                             style="color: ${info.color}" 
                             onclick="event.stopPropagation(); this.closest('.custom-select').onChange('${val}')">
                            <span>${info.dot} ${info.label}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            container.onclick = (e) => {
                e.stopPropagation();
                const wasOpen = container.classList.contains('open');
                document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
                if (!wasOpen) container.classList.add('open');
            };

            container.onChange = (val) => {
                container.classList.remove('open');
                onChange(val);
            };

            return container;
        }

        function render() {
            const validationResults = validateRules();
            const hasAnyError = validationResults.some(r => r.overlapDays.length > 0);

            // Disable/Enable Save Button
            const saveBtn = document.querySelector('.btn-save');
            if (saveBtn) {
                const dirty = isDirty();
                saveBtn.disabled = hasAnyError || !dirty;

                if (hasAnyError) {
                    saveBtn.title = "Fix overlapping rules before saving";
                } else if (!dirty) {
                    saveBtn.title = "No changes to save";
                } else {
                    saveBtn.title = "Apply changes to device";
                }
            }

            // Render Fallback Select
            const fallbackCont = document.getElementById('fallback-select-container');
            fallbackCont.innerHTML = '';
            fallbackCont.appendChild(createCustomSelect(config.default_state, (val) => {
                config.default_state = val;
                render();
                updateStatusDisplay();
            }));

            // Sync Startup Toggle
            document.getElementById('startup-toggle').checked = config.start_on_login;

            const container = document.getElementById('rules-container');
            container.innerHTML = '';

            config.rules.forEach((rule, idx) => {
                const row = document.createElement('div');
                row.className = 'rule-row';

                const startObj = to12h(rule.start);
                const endObj = to12h(rule.end);

                let daysHtml = '';
                DAYS.forEach(day => {
                    const active = rule.days.includes(day) ? 'active' : '';
                    daysHtml += `<div class="day-pill ${active}" onclick="toggleDay(${idx}, '${day}')">${day}</div>`;
                });

                row.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:8px; flex: 1;">
                        <div class="days-container">${daysHtml}</div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <div class="time-parts">
                                <input type="text" value="${startObj.h}:${startObj.m}" placeholder="HH:MM"
                                    onchange="updateRuleTime(${idx}, 'start', this.value, null)">
                                <select onchange="updateRuleTime(${idx}, 'start', null, this.value)">
                                    <option value="AM" ${startObj.ampm === 'AM' ? 'selected' : ''}>AM</option>
                                    <option value="PM" ${startObj.ampm === 'PM' ? 'selected' : ''}>PM</option>
                                </select>
                            </div>
                            <span class="to-label" style="width:20px; font-size:9px; opacity:0.6;">TO</span>
                            <div class="time-parts">
                                <input type="text" value="${endObj.h}:${endObj.m}" placeholder="HH:MM"
                                    onchange="updateRuleTime(${idx}, 'end', this.value, null)">
                                <select onchange="updateRuleTime(${idx}, 'end', null, this.value)">
                                    <option value="AM" ${endObj.ampm === 'AM' ? 'selected' : ''}>AM</option>
                                    <option value="PM" ${endObj.ampm === 'PM' ? 'selected' : ''}>PM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="status-col" style="min-width: 110px;"></div>
                        <div style="display:flex; align-items:center; gap:4px;">
                            <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleEnabled(${idx}, this.checked)">
                            <span style="font-size:9px; font-weight:800; color: var(--text-sec);">ON</span>
                        </div>
                        <button class="btn-del" onclick="removeRule(${idx})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;

                const statusCol = row.querySelector('.status-col');
                statusCol.appendChild(createCustomSelect(rule.state, (val) => {
                    config.rules[idx].state = val;
                    config.rules[idx]._touched = true;
                    render();
                    updateStatusDisplay();
                }));

                container.appendChild(row);

                const errorInfo = validationResults[idx];
                const someRuleTouched = config.rules.some(r => r._touched);

                if (errorInfo.overlapDays.length > 0 && (!someRuleTouched || rule._touched)) {
                    row.classList.add('has-error');
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'validation-msg';
                    msgDiv.innerHTML = `
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        Overlaps on ${errorInfo.overlapDays.join(', ')}
                    `;
                    container.appendChild(msgDiv);
                }
            });
        }

        // Global click to close dropdowns
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
        });

        function toggleDay(idx, day) {
            const rule = config.rules[idx];
            rule._touched = true;
            if (rule.days.includes(day)) {
                rule.days = rule.days.filter(d => d !== day);
            } else {
                rule.days.push(day);
            }
            render();
            updateStatusDisplay();
        }

        function updateRuleTime(idx, key, timePart, ampmPart) {
            const rule = config.rules[idx];
            const currentObj = to12h(rule[key]);
            const newHMM = timePart || `${currentObj.h}:${currentObj.m}`;
            const newAMPM = ampmPart || currentObj.ampm;

            const [h, m] = newHMM.split(':');
            rule[key] = to24h(h, m || "00", newAMPM);
            rule._touched = true;
            render();
            updateStatusDisplay();
        }

        function updateRuleState(idx, select) {
            config.rules[idx].state = select.value;
            updateSelectColor(select);
            updateStatusDisplay();
        }

        function updateSelectColor(select) {
            select.className = 'state-select ' + select.value;
        }

        function toggleEnabled(idx, val) {
            config.rules[idx].enabled = val;
            config.rules[idx]._touched = true;
            render();
            updateStatusDisplay();
        }

        function syncDefault() {
            const select = document.getElementById('default-state');
            config.default_state = select.value;
            updateSelectColor(select);
            render();
            updateStatusDisplay();
        }

        function addRule() {
            config.rules.push({ days: ["Mon", "Tue", "Wed", "Thu", "Fri"], start: "09:00", end: "17:00", state: "focused", enabled: true, _touched: true });
            render();
            updateStatusDisplay();
        }

        function removeRule(idx) {
            config.rules.splice(idx, 1);
            render();
            updateStatusDisplay();
        }

        async function updateStatusDisplay() {
            // Fetch the very latest config to check for manual overrides from the tray
            const r = await fetch('/config');
            const liveConfig = await r.json();

            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const dayStr = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][now.getDay()];

            let status = liveConfig.default_state || config.default_state;
            let isManual = false;

            const mv = liveConfig.manual_override;
            if (mv && mv.toLowerCase() !== "none" && mv.toLowerCase() !== "null") {
                status = mv;
                isManual = true;
            } else {
                config.rules.forEach(r => {
                    if (!r.enabled) return;
                    if (r.days.includes(dayStr)) {
                        if (isBetween(timeStr, r.start, r.end)) status = r.state;
                    }
                });
            }

            // Update Device Status
            const devStatus = liveConfig.device_status || "searching";
            const devTxt = document.getElementById('device-txt');
            const devDot = document.getElementById('device-dot');

            if (devStatus === "connected") {
                devTxt.innerText = "Device connected";
                devDot.style.background = "#10b981";
            } else if (devStatus === "not_detected") {
                devTxt.innerText = "Device not detected";
                devDot.style.background = "#ef4444";
            } else {
                devTxt.innerText = "Connecting / issue";
                devDot.style.background = "#f59e0b";
            }

            const colors = {
                open: '#10b981', green: '#10b981',
                focused: '#ef4444', red: '#ef4444',
                away: '#3b82f6', blue: '#3b82f6',
                off: '#94a3b8'
            };
            const txt = document.getElementById('status-txt');
            txt.innerText = (isManual ? "Manual: " : "Current Status: ") + status.charAt(0).toUpperCase() + status.slice(1);
            document.getElementById('status-dot').style.background = colors[status] || '#94a3b8';

            // Update Manual Control Button States
            const forceButtons = document.querySelectorAll('.btn-force');
            forceButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.disabled = false;
            });

            if (isManual) {
                // Map the current status to its button ID
                const activeBtnId = "btn-" + status;
                const activeBtn = document.getElementById(activeBtnId);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }

            // Show/Hide Resume button
            document.getElementById('resume-btn').style.display = isManual ? 'block' : 'none';
        }

        async function forceState(state) {
            console.log("Forcing state:", state);
            await fetch('/force', {
                method: 'POST',
                body: JSON.stringify({ state: state })
            });
            updateStatusDisplay();
        }

        function isBetween(now, start, end) {
            if (start <= end) return now >= start && now < end;
            return now >= start || now < end;
        }

        async function saveConfig() {
            // Clean up UI-only flags before saving/comparing
            config.rules.forEach(r => delete r._touched);

            await fetch('/save', { method: 'POST', body: JSON.stringify(config) });
            initialConfig = JSON.stringify(config); // Update saved reference
            render(); // Refresh UI to disable save button
            const toast = document.getElementById('toast');
            toast.className = 'show';
            setTimeout(() => toast.className = '', 3000);
        }

        load();
        // Maximum snappiness: 1s interval, only when tab is active
        setInterval(() => {
            if (!document.hidden) updateStatusDisplay();
        }, 1000);
    </script>
</body>

</html>